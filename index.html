<html>
    <head>
        <title>SRE team</title>
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
        integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
        crossorigin=""/>
        <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
        integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
        crossorigin=""></script>
        <style>
            /* Hack: disable fadeout animation, so time updates look seamless. */
            .leaflet-fade-anim .leaflet-popup {
                transition: none;
            }
            .leaflet-popup-tip {
                visibility: hidden;
            }
        </style>
    </head>
    <body style="display:flex; justify-content: center;">
        <div id="mapid" style="flex-grow: 1;"></div>
        <!-- See http://joergdietrich.github.io/Leaflet.Terminator/  -->
        <script src="https://unpkg.com/@joergdietrich/leaflet.terminator@1.0.0/L.Terminator.js"></script>

        <!-- https://github.com/dj0001/Leaflet.timezones -->
        <script src="https://rawcdn.githack.com/dj0001/Leaflet.timezones/c4f81012e5025b0133b3f06110b92427eac0118e/L.timezones.js"></script>

        <script src="https://momentjs.com/downloads/moment-with-locales.min.js"></script>
        <script src="https://momentjs.com/downloads/moment-timezone-with-data-10-year-range.min.js"></script>

        <script>
            var map = L.map('mapid').setView([30,-0], 3);
            //L.tileLayer('https://maps.wikimedia.org/osm-intl/{z}/{x}/{y}.png');
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            L.timezones.addTo(map);
            var t = L.terminator();
            t.addTo(map);
            setInterval(function(){var t2 = L.terminator(); t.setLatLngs(t2.getLatLngs()); t.redraw();}, 500);
        </script>

        <script>
            // TODO: move data into separate file
            // TODO: figure out automatic updates (script to poll gcal api?)
            // TODO: probably make each person into an object, with 'tz' and maybe also 'subteam' attributes (for filtering by subteam w/ checkboxes)
            const tzPeople = {
                "America/Los_Angeles": ["walterw", "brian", "olivers"],
                "America/Chicago": ["liam", "charlie"],
                "America/New_York": ["chrisd", "bobby", "__frank__"],
                "Europe/Madrid": ["miro", "lucasl", "cosimo", "cecilia", "manon", "_giovanni_", "mateo", "javier", "ambroos"],
//                "Europe/Copenhagen": [],
                "Europe/Athens": ["dimitra", "vassilis"],
                "Asia/Singapore": ["vicente"],
            }
            for (var tz in tzPeople) {
                tzPeople[tz] = tzPeople[tz].sort();
            }

            var ourPopups = [];
            var lastDrawnMinute = -1;

            function maybeDrawPopups() {
                var now = moment();
                if (lastDrawnMinute == now.minute())
                    return;
                
                ourPopups.forEach(e => e.remove());
                ourPopups = [];

                for (var tz in tzPeople) {
                    const p = tzPeople[tz];
                    console.log(`${tz}: ${tzCoords[tz]}`);
                    const local = now.tz(tz).format('HH:mm');
                    const abbr = moment.tz.zone(tz).abbr(now);
                    ourPopups.push(L.popup({autoClose: false, closeOnClick: false})
                        .setLatLng(tzCoords[tz])
                        .setContent(`<div style="text-align:center"><b><div style="font-size: 200%">${local}</div><div style="margin-bottom:0.75em;">${abbr}</div></b>${p.join("<br>")}</div>`));
                }
                ourPopups.forEach(e => e.addTo(map));
                lastDrawnMinute = now.minute();
            }
            // TODO: times in popups should autoupdate too
            var tzCoords = {};

            // for each IANA timezone name (e.g. 'Europe/Athens'), yields the lat/long of its namesake city.  Generated by https://w.wiki/HHd
            fetch('wikidata-timezone-to-coords.json')
                .then(res => res.json())
                .then(res => {
                    res.map(tz => { tzCoords[tz.tzLabel] = [tz.lat, tz.long]; });
                    // hack
                    tzCoords['America/Chicago'] = [32.779167, -96.808889]; // Dallas
                    maybeDrawPopups();
                    setInterval(maybeDrawPopups, 500);
                });
        </script>
    </body>
</html>